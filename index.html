<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>SYSTEME COSTUME 17</title>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCmOcOnLJGmlym4Z__BG6wnb43fQK8JR6ew",
  authDomain: "costume17-79fe2.firebaseapp.com",
  databaseURL: "https://costume17-79fe2-default-rtdb.firebaseio.com",
  projectId: "costume17-79fe2",
  storageBucket: "costume17-79fe2.appspot.com",
  messagingSenderId: "186622774682",
  appId: "1:186622774682:web:f498993ae2c45423a0be23"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
</script>

<style>
body{font-family:Arial;direction:rtl;background:#f4f4f4}
.container{max-width:1100px;margin:auto;background:#fff;padding:20px;border-radius:8px}
form{display:flex;flex-wrap:wrap;gap:10px;}
form input, form select{flex:1;padding:7px;}
button{padding:7px;background:#3498db;color:#fff;border:none;border-radius:4px;cursor:pointer}
button:hover{opacity:0.8;}
table{width:100%;border-collapse:collapse;margin-top:15px}
th,td{border:1px solid #ccc;padding:6px;text-align:center;}
.returned{background:#c8f7c5}
</style>
</head>
<body>

<div class="container">
<h2>COSTUME17</h2>

<form>
<input id="fname" placeholder="الاسم">
<input id="phone" placeholder="الهاتف">
<input type="date" id="rentDate">
<input type="date" id="returnDate">

<select id="pant"></select>
<select id="shirt"></select>

<button type="button" onclick="addRental()">تأكيد التأجير</button>
</form>

<table>
<thead>
<tr>
<th>الاسم</th>
<th>الهاتف</th>
<th>السروال</th>
<th>القميص</th>
<th>تاريخ الإرجاع</th>
<th>إرجاع</th>
<th>حذف</th>
</tr>
</thead>
<tbody id="rentalsBody"></tbody>
</table>
</div>

<script>
// التاريخ اليوم
rentDate.value = new Date().toISOString().split("T")[0];

// ===== المتغيرات =====
let rentals = [];
let pants = [];
let shirts = [];

// ===== تحميل البيانات من Firebase =====
db.ref("rentals").on("value", snap => {
 rentals = snap.val() ? Object.values(snap.val()) : [];
 renderRentals();
});

db.ref("pants").on("value", snap => {
 pants = snap.val() || [];
 refreshSelects();
});

db.ref("shirts").on("value", snap => {
 shirts = snap.val() || [];
 refreshSelects();
});

// ===== إنشاء افتراضي للمخزون =====
function initStock(){
 if(pants.length===0){
  for(let i=1;i<=10;i++)
   pants.push({name:"سروال "+i,size:42,status:"متوفر"});
  db.ref("pants").set(pants);
 }
 if(shirts.length===0){
  ["S","M","L","XL"].forEach(s=>shirts.push({name:"قميص",size:s,status:"متوفر"}));
  db.ref("shirts").set(shirts);
 }
}
setTimeout(initStock,1000);

// ===== تعبئة القوائم =====
function fillSelect(id,arr){
 let s=document.getElementById(id);
 s.innerHTML="<option value=''>--اختيار--</option>";
 arr.forEach((x,i)=>{
  let o=document.createElement("option");
  o.value=i;
  o.text = x.name+" "+x.size+" ("+x.status+")";
  if(x.status!=="متوفر") o.disabled=true;
  s.appendChild(o);
 });
}
function refreshSelects(){
 fillSelect("pant",pants);
 fillSelect("shirt",shirts);
}

// ===== إضافة =====
function addRental(){
 let r={
  fname:fname.value,
  phone:phone.value,
  pant:pant.value,
  shirt:shirt.value,
  returnDate:returnDate.value,
  returned:false
 };

 if(r.pant!=="") pants[r.pant].status="مؤجر";
 if(r.shirt!=="") shirts[r.shirt].status="مؤجر";

 db.ref("pants").set(pants);
 db.ref("shirts").set(shirts);
 db.ref("rentals").push(r);
}

// ===== عرض =====
function renderRentals(){
 rentalsBody.innerHTML="";
 rentals.forEach((r,i)=>{
 rentalsBody.innerHTML+=`
 <tr class="${r.returned?'returned':''}">
 <td>${r.fname}</td>
 <td>${r.phone}</td>
 <td>${getName(pants,r.pant)}</td>
 <td>${getName(shirts,r.shirt)}</td>
 <td>${r.returnDate||""}</td>
 <td><button onclick="returnRental(${i})">إرجاع</button></td>
 <td><button onclick="deleteRental(${i})">حذف</button></td>
 </tr>`;
});
}

// ===== أدوات =====
function getName(arr,i){
 return arr[i]?arr[i].name+" "+arr[i].size:"";
}

// ===== إرجاع =====
function returnRental(i){
 let r=rentals[i];
 if(r.pant!=="") pants[r.pant].status="متوفر";
 if(r.shirt!=="") shirts[r.shirt].status="متوفر";
 r.returned=true;
 db.ref("pants").set(pants);
 db.ref("shirts").set(shirts);
 db.ref("rentals").set(rentals);
}

// ===== حذف =====
function deleteRental(i){
 rentals.splice(i,1);
 db.ref("rentals").set(rentals);
}
</script>

</body>
</html>
